<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½å†œä¸šæ¨¡æ‹Ÿç³»ç»Ÿ</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #45a049;
        }

        body {
            font-family: 'Segoe UI', system-ui;
            margin: 0;
            padding: 20px;
            background-color: #f0f5f0;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .panel:hover {
            transform: translateY(-2px);
        }

        h2 {
            color: var(--primary-color);
            margin-top: 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        input,
        select,
        button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .running {
            background: #4CAF50;
        }

        .paused {
            background: #FFC107;
        }

        .stopped {
            background: #F44336;
        }

        #ws-log {
            height: 200px;
            overflow-y: auto;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .metric {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="panel">
        <h2>æ¨¡æ‹Ÿæ§åˆ¶</h2>
        <div class="form-group">
            <input type="text" id="sim-name" placeholder="æ¨¡æ‹Ÿåç§°">
            <input type="text" id="sim-desc" placeholder="æ¨¡æ‹Ÿæè¿°">
            <button onclick="createSimulation()">æ–°å»ºæ¨¡æ‹Ÿ</button>
            <button onclick="startSimulation()">å¯åŠ¨</button>
            <button onclick="pauseSimulation()">æš‚åœ</button>
            <button onclick="endSimulation()">ç»“æŸ</button>
        </div>
        <div id="sim-status" class="status-indicator stopped"></div>
        <span id="current-simulation">å½“å‰æ¨¡æ‹Ÿï¼šæ— </span>
    </div>

    <!-- ç¯å¢ƒé…ç½®æ¨¡å— -->
    <div class="panel">
        <h2>ç¯å¢ƒé…ç½®</h2>
        <div class="form-group">
            <input type="number" id="temp" placeholder="æ¸©åº¦ (â„ƒ)" step="0.1">
            <input type="number" id="soil" placeholder="åœŸå£¤è‚¥åŠ› (%)" min="0" max="100">
            <input type="number" id="rain" placeholder="é™æ°´é‡ (mm)" min="0">
            <select id="terrain">
                <option value="å¹³åŸ">å¹³åŸ</option>
                <option value="å±±åœ°">å±±åœ°</option>
                <option value="ä¸˜é™µ">ä¸˜é™µ</option>
            </select>
            <button onclick="updateEnvironment()">æ›´æ–°ç¯å¢ƒ</button>
        </div>
    </div>

    <!-- ä½œç‰©ç®¡ç†æ¨¡å— -->
    <div class="panel">
        <h2>ä½œç‰©ç®¡ç†</h2>
        <div class="form-group">
            <input type="text" id="crop-name" placeholder="ä½œç‰©åç§°">
            <div class="data-grid">
                <input type="number" id="growth-rate" placeholder="ç”Ÿé•¿ç‡" step="0.1" min="0">
                <input type="number" id="temp-weight" placeholder="æ¸©åº¦æƒé‡" step="0.1" min="0" max="1">
                <input type="number" id="soil-weight" placeholder="åœŸå£¤æƒé‡" step="0.1" min="0" max="1">
                <input type="number" id="water-weight" placeholder="æ°´åˆ†æƒé‡" step="0.1" min="0" max="1">
            </div>
            <button onclick="createCrop()">åˆ›å»ºä½œç‰©</button>
        </div>
        <div id="crop-list"></div>
    </div>

    <!-- Agentæ§åˆ¶å° -->
    <div class="panel">
        <h2>Agentæ§åˆ¶å°</h2>
        <div class="form-group">
            <select id="agent-type">
                <option value="FARMER">å†œæ°‘</option>
                <option value="AGRONOMIST">å†œä¸šä¸“å®¶</option>
                <option value="METEOROLOGIST">æ°”è±¡ä¸“å®¶</option>
            </select>
            <button onclick="createAgent()">åˆ›å»ºAgent</button>
            <button onclick="triggerDecision()">è§¦å‘å†³ç­–</button>
        </div>
        <div id="agent-list"></div>
    </div>

    <!-- å®æ—¶æ•°æ®çœ‹æ¿ -->
    <div class="panel">
        <h2>å®æ—¶ç›‘æ§</h2>
        <div class="data-grid">
            <div class="metric">
                <h3>ğŸŒ¡ï¸ æ¸©åº¦</h3>
                <span id="current-temp">-</span>â„ƒ
            </div>
            <div class="metric">
                <h3>ğŸŒ± åœŸå£¤è‚¥åŠ›</h3>
                <span id="current-soil">-</span>%
            </div>
            <div class="metric">
                <h3>ğŸ’§ é™æ°´é‡</h3>
                <span id="current-rain">-</span>mm
            </div>
            <div class="metric">
                <h3>â³ æ¨¡æ‹Ÿå¤©æ•°</h3>
                <span id="sim-days">0</span>å¤©
            </div>
        </div>
    </div>

    <!-- WebSocketæ—¥å¿— -->
    <div class="panel">
        <h2>å®æ—¶äº‹ä»¶</h2>
        <div id="ws-log"></div>
    </div>
    </div>

    <script>
        let currentSimulationId = null;
        let ws = null;

        // WebSocketè¿æ¥
        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8080/ws/simulation');

            ws.onmessage = (event) => {
                const log = document.getElementById('ws-log');
                const entry = document.createElement('div');
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${event.data}`;
                log.prepend(entry);
            };

            ws.onerror = (error) => {
                console.error('WebSocketé”™è¯¯:', error);
            };
        }

        // æ¨¡æ‹Ÿæ§åˆ¶
        async function createSimulation() {
            const name = document.getElementById('sim-name').value;
            const description = document.getElementById('sim-desc').value;

            if (!name || !description) {
                alert('è¯·è¾“å…¥æ¨¡æ‹Ÿåç§°å’Œæè¿°');
                return;
            }

            try {
                const res = await fetch('/api/simulation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });

                if (!res.ok) {
                    const error = await res.text();
                    throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯ï¼š${error}`);
                }

                const data = await res.json();
                currentSimulationId = data.id;
                document.getElementById('current-simulation').textContent =
                    `å½“å‰æ¨¡æ‹Ÿï¼š${data.id}`;
                connectWebSocket();
            } catch (error) {
                console.error('åˆ›å»ºæ¨¡æ‹Ÿå¤±è´¥:', error);
                alert(`åˆ›å»ºæ¨¡æ‹Ÿå¤±è´¥ï¼š${error.message}`);
            }
        }

        // ç¯å¢ƒæ›´æ–°
        async function updateEnvironment() {
            const envData = {
                temperature: parseFloat(document.getElementById('temp').value),
                soilFertility: parseFloat(document.getElementById('soil').value),
                precipitation: parseFloat(document.getElementById('rain').value),
                terrain: document.getElementById('terrain').value,
                simulationId: currentSimulationId
            };

            await fetch('/api/environments/custom', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(envData)
            });
        }

        // ä½œç‰©ç®¡ç†
        async function createCrop() {
            const cropData = {
                cropName: document.getElementById('crop-name').value,
                growthRate: parseFloat(document.getElementById('growth-rate').value),
                tempWeight: parseFloat(document.getElementById('temp-weight').value),
                soilWeight: parseFloat(document.getElementById('soil-weight').value),
                waterWeight: parseFloat(document.getElementById('water-weight').value),
                simulationId: currentSimulationId
            };

            await fetch('/api/crop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cropData)
            });
        }

        // Agentç®¡ç†
        async function createAgent() {
            const agentType = document.getElementById('agent-type').value;
            await fetch('/api/agent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    agentName: `${agentType}-${Date.now()}`,
                    roleType: agentType,
                    simulationId: currentSimulationId
                })
            });
        }

        // å®æ—¶æ•°æ®æ›´æ–°
        setInterval(async () => {
            if (!currentSimulationId) return;

            const res = await fetch(`/api/environments/latest?simulationId=${currentSimulationId}`);
            const env = await res.json();

            document.getElementById('current-temp').textContent = env.temperature.toFixed(1);
            document.getElementById('current-soil').textContent = (env.soilFertility * 100).toFixed(0);
            document.getElementById('current-rain').textContent = env.precipitation.toFixed(1);
        }, 5000);
    </script>
</body>

</html>